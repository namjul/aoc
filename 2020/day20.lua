local inspect = require('inspect')
local utils = require('utils')

-- run `lua ./day20.lua`

-- Tile 2311:
-- ..##.#..#.
-- ##..#.....
-- #...##..#.
-- ####.#...#
-- ##.##.###.
-- ##...#.###
-- .#.#.#..##
-- ..#....#..
-- ###...#.#.
-- ..###..###
-- 
-- Tile 1951:
-- #.##...##.
-- #.####...#
-- .....#..##
-- #...######
-- .##.#....#
-- .###.#####
-- ###.##.##.
-- .###....#.
-- ..#.#..#.#
-- #...##.#..
-- 
-- Tile 1171:
-- ####...##.
-- #..##.#..#
-- ##.#..#.#.
-- .###.####.
-- ..###.####
-- .##....##.
-- .#...####.
-- #.##.####.
-- ####..#...
-- .....##...
-- 
-- Tile 1427:
-- ###.##.#..
-- .#..#.##..
-- .#.##.#..#
-- #.#.#.##.#
-- ....#...##
-- ...##..##.
-- ...#.#####
-- .#.####.#.
-- ..#..###.#
-- ..##.#..#.
-- 
-- Tile 1489:
-- ##.#.#....
-- ..##...#..
-- .##..##...
-- ..#...#...
-- #####...#.
-- #..#.#.#.#
-- ...#.#.#..
-- ##.#...##.
-- ..##.##.##
-- ###.##.#..
-- 
-- Tile 2473:
-- #....####.
-- #..#.##...
-- #.##..#...
-- ######.#.#
-- .#...#.#.#
-- .#########
-- .###.#..#.
-- ########.#
-- ##...##.#.
-- ..###.#.#.
-- 
-- Tile 2971:
-- ..#.#....#
-- #...###...
-- #.#.###...
-- ##.##..#..
-- .#####..##
-- .#..####.#
-- #..#.#..#.
-- ..####.###
-- ..#.#.###.
-- ...#.#.#.#
-- 
-- Tile 2729:
-- ...#.#.#.#
-- ####.#....
-- ..#.#.....
-- ....#..#.#
-- .##..##.#.
-- .#.####...
-- ####.#.#..
-- ##.####...
-- ##..#.##..
-- #.##...##.
-- 
-- Tile 3079:
-- #.#.#####.
-- .#..######
-- ..#.......
-- ######....
-- ####.#..#.
-- .#...#.##.
-- #.#####.##
-- ..#.###...
-- ..#.......
-- ..#.###...
--
--
-- 1951       2311       3079
-- #...##.#.. ..###..### #.#.#####.
-- ..#.#..#.# ###...#.#. .#..######
-- .###....#. ..#....#.. ..#.......
-- ###.##.##. .#.#.#..## ######....
-- .###.##### ##...#.### ####.#..#.
-- .##.#....# ##.##.###. .#...#.##.
-- #...###### ####.#...# #.#####.##
-- .....#..## #...##..#. ..#.###...
-- #.####...# ##..#..... ..#.......
-- #.##...##. ..##.#..#. ..#.###...
--
-- 2729       1427       2473
-- #.##...##. ..##.#..#. ..#.###...
-- ##..#.##.. ..#..###.# ##.##....#
-- ##.####... .#.####.#. ..#.###..#
-- ####.#.#.. ...#.##### ###.#..###
-- .#.####... ...##..##. .######.##
-- .##..##.#. ....#...## #.#.#.#...
-- ....#..#.# #.#.#.##.# #.###.###.
-- ..#.#..... .#.##.#..# #.###.##..
-- ####.#.... .#..#.##.. .######...
-- ...#.#.#.# ###.##.#.. .##...####
--
-- 2971       1489       1171
-- ...#.#.#.# ###.##.#.. .##...####
-- ..#.#.###. ..##.##.## #..#.##..#
-- ..####.### ##.#...##. .#.#..#.##
-- #..#.#..#. ...#.#.#.. .####.###.
-- .#..####.# #..#.#.#.# ####.###..
-- .#####..## #####...#. .##....##.
-- ##.##..#.. ..#...#... .####...#.
-- #.#.###... .##..##... .####.##.#
-- #...###... ..##...#.. ...#..####
-- ..#.#....# ##.#.#.... ...##.....
-- 
-- 
-- 

-- Tile 2311
-- Tile 1951
-- Tile 1171
-- Tile 1427
-- Tile 1489
-- Tile 2473
-- Tile 2971
-- Tile 2729/problems/missing-number/description/
-- Tile 3079



-- local tiles = {
--   ['#...##.#..'] = {},
--   ['..###..###'] = {},
--   ['#.#.#####.'] = {},
--   ['#.##...###'] = {
--     [3931] = 'bottom',
--     [20302] =  'top'
--   }
-- }
--
--


local current
local tileRow
local tiles = {}

-- tile structure:
-- index
-- 1: top
-- 2: right
-- 3: bottom
-- 4: left

for line in utils.day(20) do
  local id = line:match('(%d+)')
  if id then
    current = id
    tileRow = 1
  else
    if line ~= '' then
      local tile = tiles[current] or {}

      if tileRow == 1 then
        tile[1] = line
      elseif tileRow == 10 then
        tile[3] = line:reverse()
      end
        local left, right = line:match('^([#.]).*([#.])$')
        tile[2] = (tile[2] or '')..right
        tile[4] = left..(tile[4] or '')
     
      tiles[current] = tile
      tileRow = tileRow + 1
    end
  end

end

-- print(inspect(tiles))

local function match(tile1, tile2)
  local result = {}
  for i, edge1 in ipairs(tile1) do
    for j, edge2 in ipairs(tile2) do
      if (edge1 == edge2) or (edge1 == edge2:reverse()) then
        table.insert(result, edge1)
      end
    end
  end
  return result
end

local done = {}
local matchCount = {}
for idOuter, tileOuter in pairs(tiles) do
  for idInner, tileInner in pairs(tiles) do

    if idOuter ~= idInner and not (done[idOuter..idInner] or done[idInner..idOuter]) then
      local matches = match(tileOuter, tileInner)
      if #matches > 0 then
        matchCount[idOuter] = (matchCount[idOuter] or 0) + 1
        matchCount[idInner] = (matchCount[idInner] or 0) + 1
      end
      done[idOuter..idInner] = true
    end

  end
end

local count = 1
for id, value in pairs(matchCount) do
  if value == 2 then
    count = count * id
  end
end
print(count)
